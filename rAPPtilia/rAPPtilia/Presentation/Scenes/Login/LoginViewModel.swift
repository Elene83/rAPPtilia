import UIKit

class LoginViewModel {
    //MARK: Properties
    private let loginUseCase: LoginUseCase
    private let authRepository: AuthRepository
    
    var onLoginSuccess: (() -> Void)?
    var onLoginError: ((String) -> Void)?
    
    //MARK: Inits
    init(authRepository: AuthRepository) {
        self.authRepository = authRepository
        self.loginUseCase = LoginUseCase(authRepository: authRepository)
    }
    
    //MARK: Methods
    func login(email: String, password: String) {
        if let validationError = validateLoginInputs(email: email, password: password) {
            onLoginError?(validationError)
            return
        }
        
        LoaderManager.shared.show()
        loginUseCase.execute(email: email, password: password) { [weak self] result in
            DispatchQueue.main.async {
                LoaderManager.shared.hide()
                
                switch result {
                case .success:
                    self?.onLoginSuccess?()
                case .failure(let error):
                    let errorMessage = self?.mapFirebaseError(error) ?? error.localizedDescription
                    self?.onLoginError?(errorMessage)
                }
            }
        }
    }
    
    func signInWithGoogle(presentingViewController: UIViewController) {
        authRepository.signInWithGoogle(presentingViewController: presentingViewController) { [weak self] result in
            DispatchQueue.main.async {
                switch result {
                case .success:
                    self?.onLoginSuccess?()
                case .failure(let error):
                    self?.onLoginError?(error.localizedDescription)
                }
            }
        }
    }
    
    private func isValidEmail(_ email: String) -> Bool {
        let emailRegex = "[A-Z0-9a-z._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,64}"
        let emailPredicate = NSPredicate(format: "SELF MATCHES %@", emailRegex)
        return emailPredicate.evaluate(with: email)
    }
    
    private func validateLoginInputs(email: String, password: String) -> String? {
        guard !email.isEmpty else {
            return "Email is required"
        }
        
        guard isValidEmail(email) else {
            return "Please enter a valid email address"
        }
        
        guard !password.isEmpty else {
            return "Password is required"
        }
        
        return nil
    }
        
    private func mapFirebaseError(_ error: Error) -> String {
        let errorCode = (error as NSError).code
        
        switch errorCode {
        case 17011:
            return "No account found with this email"
        case 17009:
            return "Incorrect password"
        case 17008:
            return "Invalid email address"
        case 17010:
            return "This account has been disabled"
        case 17020:
            return "Network error. Please check your connection"
        default:
            return error.localizedDescription
        }
    }
}
